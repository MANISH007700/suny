import streamlit as st
import requests
import time
from datetime import date, datetime
import logging
from typing import Dict
import numpy as np

# === Config & Logging ===
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

st.set_page_config(
    page_title="SUNY Academic Guidance",
    page_icon="üìö",
    layout="wide",
    initial_sidebar_state="expanded"
)

API_BASE = "http://localhost:8888"

# === Modern CSS - Light Theme with Company Colors ===
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * {font-family: 'Inter', sans-serif;}
    
    /* Light theme background */
    .main {
        background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
    }
    
    /* Sidebar styling */
    [data-testid="stSidebar"] {
        background: linear-gradient(180deg, #07407b 0%, #0b0f3b 100%);
        border-right: 2px solid #7fcdee;
    }
    
    [data-testid="stSidebar"] * {
        color: #fafafa !important;
    }
    
    /* Headers */
    h1 {
        color: #07407b;
        font-weight: 700;
        text-align: left;
        margin-bottom: 0.5rem;
    }
    
    h2 {
        color: #07407b;
        font-weight: 600;
        font-size: 1.5rem;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
    
    h3 {
        color: #0b0f3b;
        font-weight: 600;
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
    }
    
    /* Buttons */
    .stButton>button {
        background: linear-gradient(135deg, #07407b 0%, #0b0f3b 100%);
        color: #fafafa;
        border: none;
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(7, 64, 123, 0.3);
        transition: all 0.3s ease;
    }
    
    .stButton>button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(7, 64, 123, 0.4);
        background: linear-gradient(135deg, #0b0f3b 0%, #07407b 100%);
    }
    
    /* Secondary buttons */
    .stButton>button[kind="secondary"] {
        background: linear-gradient(135deg, #f7931e 0%, #ff8c42 100%);
        color: #fafafa;
    }
    
    .stButton>button[kind="secondary"]:hover {
        background: linear-gradient(135deg, #ff8c42 0%, #f7931e 100%);
    }
    
    /* Metric cards - clean tiles */
    [data-testid="stMetric"] {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(7, 64, 123, 0.08);
        border: 1px solid #E9ECEF;
        transition: all 0.3s ease;
    }
    
    [data-testid="stMetric"]:hover {
        box-shadow: 0 4px 16px rgba(7, 64, 123, 0.12);
        transform: translateY(-2px);
    }
    
    [data-testid="stMetric"] label {
        color: #6C757D;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    [data-testid="stMetric"] [data-testid="stMetricValue"] {
        color: #07407b;
        font-size: 2rem;
        font-weight: 700;
    }
    
    /* Card containers */
    .dashboard-card {
        background: white;
        padding: 1.8rem;
        border-radius: 20px;
        box-shadow: 0 2px 12px rgba(7, 64, 123, 0.08);
        border: 1px solid #E9ECEF;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
        box-shadow: 0 4px 20px rgba(7, 64, 123, 0.12);
    }
    
    .gradient-card {
        background: linear-gradient(135deg, #07407b 0%, #0b0f3b 100%);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(7, 64, 123, 0.2);
        margin-bottom: 1.5rem;
        color: white;
    }
    
    .gradient-card-orange {
        background: linear-gradient(135deg, #f7931e 0%, #ff6b6b 100%);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(247, 147, 30, 0.2);
        margin-bottom: 1.5rem;
        color: white;
    }
    
    /* Info boxes */
    .info-box {
        background: linear-gradient(135deg, #7fcdee20 0%, #7fcdee10 100%);
        border-left: 4px solid #7fcdee;
        padding: 1.2rem;
        border-radius: 12px;
        margin: 1rem 0;
        color: #07407b;
    }
    
    .warning-box {
        background: linear-gradient(135deg, #f7931e20 0%, #f7931e10 100%);
        border-left: 4px solid #f7931e;
        padding: 1.2rem;
        border-radius: 12px;
        margin: 1rem 0;
        color: #0b0f3b;
    }
    
    .success-box {
        background: linear-gradient(135deg, #28a74520 0%, #28a74510 100%);
        border-left: 4px solid #28a745;
        padding: 1.2rem;
        border-radius: 12px;
        margin: 1rem 0;
        color: #0b0f3b;
    }
    
    /* Chat messages for student mode */
    .chat-message {
        padding: 1.25rem;
        border-radius: 16px;
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from {opacity: 0; transform: translateY(10px);}
        to {opacity: 1; transform: translateY(0);}
    }
    
    .user-message {
        background: linear-gradient(135deg, #7fcdee 0%, #7fcdee 100%);
        color: #0b0f3b;
        margin-left: 15%;
        box-shadow: 0 2px 12px rgba(127, 205, 238, 0.3);
        border: 1px solid #7fcdee;
    }
    
    .assistant-message {
        background: white;
        color: #0b0f3b;
        margin-right: 15%;
        border: 1px solid #DEE2E6;
        box-shadow: 0 2px 8px rgba(7, 64, 123, 0.08);
    }
    
    .citation-box {
        background: #F8F9FA;
        border-left: 4px solid #07407b;
        padding: 1rem;
        margin: 0.75rem 0;
        border-radius: 8px;
        border: 1px solid #E9ECEF;
    }
    
    .citation-title {
        color: #07407b;
        font-weight: 600;
    }
    
    /* Escalation notice */
    .escalation-notice {
        background: white;
        border: 2px solid #f7931e;
        border-radius: 16px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 4px 16px rgba(247, 147, 30, 0.15);
    }
    
    /* Expander styling */
    [data-testid="stExpander"] {
        background: white;
        border: 1px solid #E9ECEF;
        border-radius: 12px;
        margin-bottom: 0.8rem;
        box-shadow: 0 2px 8px rgba(7, 64, 123, 0.06);
    }
    
    /* Student/Escalation cards */
    .student-card {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        border-left: 5px solid #07407b;
        box-shadow: 0 2px 10px rgba(7, 64, 123, 0.08);
        margin: 1rem 0;
        transition: all 0.3s ease;
    }
    
    .student-card:hover {
        box-shadow: 0 4px 16px rgba(7, 64, 123, 0.12);
        transform: translateX(4px);
    }
    
    .student-card-critical {
        border-left-color: #dc3545;
    }
    
    .student-card-high {
        border-left-color: #f7931e;
    }
    
    .student-card-medium {
        border-left-color: #ffc107;
    }
    
    .student-card-low {
        border-left-color: #28a745;
    }
    
    /* Stats tiles */
    .stat-tile {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 2px 12px rgba(7, 64, 123, 0.08);
        border: 1px solid #E9ECEF;
        margin-bottom: 1rem;
    }
    
    .stat-tile-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #07407b;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    .stat-tile-label {
        font-size: 0.875rem;
        color: #6C757D;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    /* Footer */
    .footer {
        text-align: center;
        color: #6C757D;
        font-size: 0.85rem;
        padding: 2rem 0;
        border-top: 1px solid #E9ECEF;
        margin-top: 3rem;
    }
    
    .footer-highlight {
        color: #07407b;
        font-weight: 600;
    }
    
    /* Tabs */
    .stTabs [data-baseweb="tab-list"] {
        gap: 8px;
        background: white;
        padding: 0.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(7, 64, 123, 0.06);
    }
    
    .stTabs [data-baseweb="tab"] {
        background: transparent;
        color: #6C757D;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    
    .stTabs [aria-selected="true"] {
        background: linear-gradient(135deg, #07407b 0%, #0b0f3b 100%);
        color: white;
    }
    
    /* Spinner */
    .stSpinner > div {
        border-top-color: #07407b !important;
    }
    
    /* Block container */
    .block-container {
        padding-top: 2rem;
        padding-bottom: 6rem;
        max-width: 1400px;
    }
    
    /* Remove Streamlit branding */
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
    
    /* Section headers */
    .section-header {
        color: #07407b;
        font-size: 1.75rem;
        font-weight: 700;
        margin-top: 2.5rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 3px solid #7fcdee;
    }
    
    /* Mini stat cards */
    .mini-stat {
        background: linear-gradient(135deg, #ffffff 0%, #F8F9FA 100%);
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid #E9ECEF;
        text-align: center;
    }
    
    .mini-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #07407b;
    }
    
    .mini-stat-label {
        font-size: 0.75rem;
        color: #6C757D;
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
</style>
""", unsafe_allow_html=True)

# === Session State ===
for key in ['messages', 'citations', 'initialized', 'auto_init_done', 'study_materials', 
            'student_id', 'selected_escalation', 'advisor_mode', 'admin_mode', 'show_escalation_form',
            'last_question', 'last_answer', 'last_escalation_id']:
    if key not in st.session_state:
        if key in ['messages', 'citations', 'study_materials']:
            st.session_state[key] = []
        elif key == 'student_id':
            st.session_state[key] = "STUDENT_001"  # Default student ID
        elif key in ['advisor_mode', 'admin_mode', 'show_escalation_form']:
            st.session_state[key] = False
        elif key in ['last_question', 'last_answer']:
            st.session_state[key] = ""
        elif key == 'last_escalation_id':
            st.session_state[key] = None
        else:
            st.session_state[key] = False

# === Helper Functions ===
def check_health(): 
    try: 
        return requests.get(f"{API_BASE}/academic/health", timeout=10).status_code == 200 
    except: 
        return False

def check_vector_store_status():
    try:
        r = requests.get(f"{API_BASE}/academic/status", timeout=10)
        if r.status_code == 200:
            data = r.json()
            return data.get('is_populated', False), data.get('count', 0)
        return False, 0
    except:
        return False, 0

def initialize_system(force_rebuild=False):
    try:
        with st.spinner("Processing PDFs..."):
            r = requests.post(
                f"{API_BASE}/academic/init", 
                json={"pdf_dir": "data/pdfs/", "force_rebuild": force_rebuild}, 
                timeout=300
            )
            if r.status_code == 200:
                data = r.json()
                st.session_state.initialized = True
                return True, data['message'], data.get('count', 0), data.get('skipped', False)
            return False, f"Error: {r.text}", 0, False
    except Exception as e:
        return False, str(e), 0, False

def send_message(question: str, top_k: int = 5, student_id: str = None):
    try:
        r = requests.post(
            f"{API_BASE}/academic/chat", 
            json={"question": question, "top_k": top_k, "student_id": student_id}, 
            timeout=120
        )
        return r.json() if r.status_code == 200 else {"answer": "Error", "citations": [], "escalation_id": None}
    except Exception as e:
        logger.error(f"Error sending message: {e}")
        return {"answer": "Connection error", "citations": [], "escalation_id": None}

# === Auto-Initialize on First Load ===
if not st.session_state.auto_init_done:
    st.session_state.auto_init_done = True
    
    if check_health():
        populated, count = check_vector_store_status()
        
        if populated and count > 0:
            st.session_state.initialized = True
            st.success(f"‚úÖ Knowledge base loaded! ({count} chunks available)")
            logger.info(f"Auto-init: Vector store already populated with {count} chunks")
        else:
            logger.info("Auto-init: Vector store empty, initializing...")
            st.info("üîÑ First-time setup: Processing academic documents...")
            success, msg, final_count, skipped = initialize_system(force_rebuild=False)
            
            if success:
                st.session_state.initialized = True
                st.success(f"‚úÖ System initialized! {final_count} chunks loaded")
                logger.info(f"Auto-init complete: {final_count} chunks")
            else:
                st.error(f"‚ùå Initialization failed: {msg}")
                logger.error(f"Auto-init failed: {msg}")
    else:
        st.error("‚ùå Backend is offline. Please start the FastAPI server.")

# === Sidebar ===
with st.sidebar:
    st.markdown("# üìö SUNY Academic Assistant")
    st.markdown("<small style='color: #64748b;'>RAG + Study Tools</small>", unsafe_allow_html=True)
    st.markdown("---")
    
    # Mode toggle
    st.markdown("### üë§ User Mode")
    mode = st.radio(
        "Select Mode",
        ["üéì Student", "üë®‚Äçüè´ Advisor", "üìä Administrator"],
        index=2 if st.session_state.admin_mode else (1 if st.session_state.advisor_mode else 0),
        key="mode_radio"
    )
    st.session_state.advisor_mode = (mode == "üë®‚Äçüè´ Advisor")
    st.session_state.admin_mode = (mode == "üìä Administrator")
    
    if not st.session_state.advisor_mode:
        # Student mode: show student ID input
        st.session_state.student_id = st.text_input(
            "Student ID",
            value=st.session_state.get("student_id", "STUDENT_001"),
            key="student_id_input"
        )
    
    st.markdown("---")

    healthy = check_health()
    st.markdown("### System Status")
    if healthy:
        st.success("‚úÖ Backend Connected")
        populated, count = check_vector_store_status()
        if populated:
            st.success(f"‚úÖ Knowledge Base Ready ({count} chunks)")
            st.session_state.initialized = True
        else:
            st.warning("‚ö†Ô∏è Knowledge Base Empty")
            st.session_state.initialized = False
    else:
        st.error("‚ùå Backend Offline")
        st.session_state.initialized = False

    st.markdown("---")
    st.markdown("### üîß Initialize System")
    
    force_rebuild = st.checkbox("üîÑ Force Rebuild (Clear & Reprocess All)", key="force_cb")
    
    if force_rebuild:
        st.warning("‚ö†Ô∏è This will delete existing data and rebuild from scratch")
    
    if st.button("üöÄ Initialize System", type="primary", use_container_width=True):
        if not healthy:
            st.error("Cannot initialize: Backend is offline")
        else:
            with st.spinner("Processing PDFs..."):
                success, msg, count, skipped = initialize_system(force_rebuild)
                
                if success:
                    if skipped:
                        st.info(f"‚ÑπÔ∏è {msg}")
                    else:
                        st.success(f"‚úÖ {msg}")
                    
                    if count > 0:
                        st.info(f"üìä Vector store now has {count} chunks")
                    
                    time.sleep(1.5)
                    st.rerun()
                else:
                    st.error(f"‚ùå {msg}")

    st.markdown("---")
    st.markdown("### ‚öôÔ∏è Settings")
    top_k = st.slider("üìä Retrieval Count", 1, 10, 5, key="top_k_slider", 
                      help="Number of document chunks to retrieve per query")
    
    if st.button("üóëÔ∏è Clear Academic Chat", use_container_width=True):
        st.session_state.messages = []
        st.session_state.citations = []
        st.session_state.last_escalation_id = None
        st.session_state.last_question = ""
        st.session_state.last_answer = ""
        st.success("Chat cleared!")
        time.sleep(0.5)
        st.rerun()

# === TABS ===
if st.session_state.admin_mode:
    # Administrator mode: Analytics dashboard
    tab4 = st.container()
    tab1 = None
    tab2 = None
    tab3 = None
elif st.session_state.advisor_mode:
    # Advisor mode: Only show escalation dashboard
    tab3 = st.container()
    tab1 = None
    tab2 = None
    tab4 = None
else:
    # Student mode: Show chat and study tools
    tab1, tab2 = st.tabs(["üí¨ Academic Guidance Chat", "üìñ Study Tools"])
    tab3 = None
    tab4 = None

# === TAB 1: Academic Chat ===
if tab1:
    with tab1:
        st.markdown("# üí¨ Academic Guidance Chat")
        
        if not st.session_state.initialized:
            st.warning("‚ö†Ô∏è Please initialize the system first using the sidebar")
            st.stop()

        # Display chat messages
        for msg in st.session_state.messages:
            if msg["role"] == "user":
                st.markdown(f'<div class="chat-message user-message"><strong>You</strong><br>{msg["content"]}</div>', 
                           unsafe_allow_html=True)
            else:
                st.markdown(f'<div class="chat-message assistant-message"><strong>ü§ñ AI Advisor</strong><br>{msg["content"]}</div>', 
                           unsafe_allow_html=True)
        
        # Show auto-escalation notice with remove option
        if st.session_state.get("last_escalation_id"):
            esc_id = st.session_state.last_escalation_id
            st.markdown(f"""
            <div class="escalation-notice">
                <h4 style="color:#5eead4; margin:0 0 0.5rem 0;">üéØ Question Auto-Escalated to Human Advisor</h4>
                <p style="color:#e2e8f0; margin:0;">Your question has been automatically flagged for human review to ensure you get the best possible assistance.</p>
                <p style="color:#94a3b8; font-size:0.9rem; margin:0.5rem 0 0 0;">üìã Escalation ID: <code>{esc_id[:8]}...</code></p>
                <p style="color:#10b981; font-weight:600; margin:0.5rem 0 0 0;">‚úÖ An advisor will review this shortly and reach out to you.</p>
            </div>
            """, unsafe_allow_html=True)
            
            if st.button("‚ùå Remove Escalation", key="remove_escalation_btn", type="secondary"):
                try:
                    # Delete the escalation
                    del_resp = requests.delete(f"{API_BASE}/advisor/escalations/{esc_id}", timeout=10)
                    if del_resp.status_code == 200:
                        st.success("‚úÖ Escalation removed successfully!")
                        st.session_state.last_escalation_id = None
                        time.sleep(1)
                        st.rerun()
                    else:
                        st.error("Failed to remove escalation")
                except Exception as e:
                    st.error(f"Error removing escalation: {e}")

        # Display citations
        if st.session_state.citations:
            with st.expander("üìö View Sources", expanded=False):
                for i, c in enumerate(st.session_state.citations, 1):
                    st.markdown(f"""
                    <div class="citation-box">
                        <div class="citation-title">Source {i}: {c['doc_id']}</div>
                        <div style="color:#94a3b8;font-style:italic;">"{c['snippet'][:250]}..."</div>
                    </div>
                    """, unsafe_allow_html=True)

        # Chat input
        user_prompt = st.text_input("Ask about courses, requirements, policies...", 
                                    key="chat_text_tab",
                                    placeholder="e.g., What are the CS major requirements?")
        
        col_send, col_escalate = st.columns([3, 1])
        
        with col_send:
            send_clicked = st.button("üì§ Send", key="send_tab", type="primary", use_container_width=True)
        
        with col_escalate:
            if not st.session_state.advisor_mode and st.session_state.messages:
                escalate_clicked = st.button("üÜò Escalate to Advisor", key="escalate_btn", use_container_width=True)
            else:
                escalate_clicked = False
        
        if send_clicked or (user_prompt and user_prompt != st.session_state.get('last_prompt', '')):
            if user_prompt:
                st.session_state.last_prompt = user_prompt
                st.session_state.messages.append({"role": "user", "content": user_prompt})
                
                with st.spinner("üîç Searching knowledge base..."):
                    resp = send_message(
                        user_prompt, 
                        st.session_state.get("top_k_slider", 5),
                        st.session_state.get("student_id") if not st.session_state.advisor_mode else None
                    )
                    answer = resp.get("answer", "No answer")
                    st.session_state.messages.append({"role": "assistant", "content": answer})
                    st.session_state.citations = resp.get("citations", [])
                    
                    # Store last response for potential manual escalation
                    st.session_state.last_question = user_prompt
                    st.session_state.last_answer = answer
                    st.session_state.last_escalation_id = resp.get("escalation_id")
                
                st.rerun()
        
        # Manual Escalation Dialog
        if escalate_clicked and st.session_state.messages:
            st.session_state.show_escalation_form = True
            st.rerun()
        
        # Show manual escalation form
        if st.session_state.get("show_escalation_form", False):
            with st.form("manual_escalation_form"):
                st.markdown("### üÜò Escalate to Human Advisor")
                st.markdown("Fill in the details below to send your question to a human advisor:")
                
                # Pre-fill with last conversation
                last_q = st.session_state.get("last_question", "")
                last_a = st.session_state.get("last_answer", "")
                
                question_text = st.text_area(
                    "Your Question",
                    value=last_q,
                    height=100,
                    help="Describe your question or concern"
                )
                
                ai_response_text = st.text_area(
                    "AI Response (optional - edit if needed)",
                    value=last_a,
                    height=100,
                    help="The response you received from the AI"
                )
                
                escalation_reason = st.selectbox(
                    "Why do you need human help?",
                    [
                        "AI answer was unclear or insufficient",
                        "Need personalized academic guidance",
                        "Financial aid or scholarship question",
                        "Course registration or prerequisite issue",
                        "Academic difficulty or failing course",
                        "Need accommodation or special request",
                        "Urgent or time-sensitive matter",
                        "Other - please explain in notes"
                    ],
                    key="reason_select"
                )
                
                priority_level = st.select_slider(
                    "How urgent is this?",
                    options=[1, 2, 3, 4, 5],
                    value=2,
                    format_func=lambda x: {
                        1: "‚≠ê Low - Can wait",
                        2: "‚≠ê‚≠ê Normal",
                        3: "‚≠ê‚≠ê‚≠ê Medium - Soon",
                        4: "‚≠ê‚≠ê‚≠ê‚≠ê High - Important",
                        5: "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Critical - Urgent"
                    }[x],
                    key="priority_select"
                )
                
                additional_notes = st.text_area(
                    "Additional Context (optional)",
                    placeholder="Anything else the advisor should know...",
                    height=80,
                    key="notes_input"
                )
                
                col1, col2 = st.columns(2)
                with col1:
                    submit_escalation = st.form_submit_button("‚úÖ Submit to Advisor", type="primary", use_container_width=True)
                with col2:
                    cancel_escalation = st.form_submit_button("‚ùå Cancel", use_container_width=True)
                
                if submit_escalation and question_text:
                    # Create manual escalation
                    try:
                        import uuid
                        from datetime import datetime
                        
                        # Build conversation history from session
                        conversation_history = []
                        for msg in st.session_state.messages[-6:]:  # Last 6 messages (3 exchanges)
                            conversation_history.append({
                                "role": msg["role"],
                                "content": msg["content"],
                                "timestamp": datetime.now().isoformat()
                            })
                        
                        # Combine reason with additional notes
                        full_reason = escalation_reason
                        if additional_notes:
                            full_reason += f" | Notes: {additional_notes}"
                        
                        escalation_data = {
                            "student_id": st.session_state.get("student_id", "UNKNOWN"),
                            "question": question_text,
                            "ai_response": ai_response_text or "Manual escalation - no AI response",
                            "conversation_history": conversation_history,
                            "escalation_reason": full_reason,
                            "priority": priority_level
                        }
                        
                        # Send to API
                        create_resp = requests.post(
                            f"{API_BASE}/advisor/escalations",
                            json=escalation_data,
                            timeout=10
                        )
                        
                        if create_resp.status_code == 200:
                            esc_id = create_resp.json().get("id", "")
                            st.markdown(f"""
                            <div class="escalation-notice">
                                <h4 style="color:#5eead4; margin:0 0 0.5rem 0;">‚úÖ Escalation Submitted Successfully!</h4>
                                <p style="color:#e2e8f0; margin:0;">Your question has been sent to a human advisor for personalized assistance.</p>
                                <p style="color:#94a3b8; font-size:0.9rem; margin:0.5rem 0 0 0;">üìã Escalation ID: <code>{esc_id[:8]}...</code></p>
                                <p style="color:#10b981; font-weight:600; margin:0.5rem 0 0 0;">üéØ Priority: {'‚≠ê' * priority_level}</p>
                                <p style="color:#5eead4; margin:0.5rem 0 0 0;">An advisor will review your question and contact you soon!</p>
                            </div>
                            """, unsafe_allow_html=True)
                            st.session_state.show_escalation_form = False
                            time.sleep(3)
                            st.rerun()
                        else:
                            st.error(f"‚ùå Failed to create escalation: {create_resp.text}")
                            
                    except Exception as e:
                        st.error(f"‚ùå Error creating escalation: {e}")
                
                if cancel_escalation:
                    st.session_state.show_escalation_form = False
                    st.rerun()

# === TAB 2: Study Tools ===
if tab2:
    with tab2:
        st.markdown("# üìñ Study Tools")
        st.markdown("### Upload once ‚Üí use any tool below")

        # Upload section
        uploaded = st.file_uploader(
            "üìÑ Upload PDF / TXT files",
            type=["pdf", "txt"],
            accept_multiple_files=True,
            key="study_upload",
            help="All tools use the same content"
        )

        if uploaded:
            with st.spinner("üìñ Reading files..."):
                for file in uploaded:
                    if file.type == "application/pdf":
                        try:
                            from PyPDF2 import PdfReader
                            reader = PdfReader(file)
                            text = "\n".join([p.extract_text() or "" for p in reader.pages if p.extract_text()])
                        except Exception as e:
                            logger.error(f"Error reading PDF {file.name}: {e}")
                            text = "[Could not read PDF]"
                    else:
                        text = file.read().decode("utf-8", errors="ignore")

                    if text.strip() and text not in st.session_state.study_materials:
                        st.session_state.study_materials.append(text)
                        st.success(f"‚úÖ Loaded: **{file.name}**")

        if not st.session_state.study_materials:
            st.info("üì§ Upload your study material to unlock all tools")
            st.stop()

        total_words = sum(len(t.split()) for t in st.session_state.study_materials)
        st.caption(f"‚úÖ Ready: {len(st.session_state.study_materials)} file(s) ‚Ä¢ ~{total_words:,} words")

        material_text = "\n\n".join(st.session_state.study_materials)

        # === 1. Flashcards ===
        with st.expander("üé¥ Flashcards ‚Äì Generate & Review", expanded=False):
            col1, col2 = st.columns([3, 1])
            with col1:
                topic_fc = st.text_input("Topic (optional)", placeholder="e.g., Attention Mechanism", key="fc_topic")
            with col2:
                count_fc = st.selectbox("Cards", [2, 4, 6, 8, 10], index=2, key="fc_count")

            if st.button("üé¥ Generate Flashcards", type="primary", use_container_width=True):
                with st.spinner("Creating flashcards..."):
                    r = requests.post(f"{API_BASE}/study/flashcards", json={
                        "topic": topic_fc or "key concepts",
                        "count": count_fc,
                        "context": material_text
                    })
                    if r.status_code == 200:
                        st.session_state.flashcards = r.json().get("flashcards", [])
                        st.success(f"‚úÖ {len(st.session_state.flashcards)} cards ready!")

            if st.session_state.get("flashcards"):
                st.markdown("### Your Flashcards")
                for i, card in enumerate(st.session_state.flashcards):
                    q = card.get("question", "")
                    a = card.get("answer", "")
                    st.markdown(f"""
                    <div style="background:rgba(30,41,59,0.9); border:1px solid rgba(94,234,212,0.3); border-radius:16px; padding:1.3rem; margin:1rem 0;">
                        <strong style="color:#5eead4;">Q{i+1}: {q}</strong><br><br>
                        <details><summary style="color:#94a3b8; cursor:pointer;">Show Answer</summary>
                        <p style="color:#e2e8f0; margin-top:0.8rem;">{a}</p></details>
                    </div>
                    """, unsafe_allow_html=True)

        # === 2. Practice Quiz ===
        with st.expander("‚úÖ Practice Quiz ‚Äì Test Yourself", expanded=False):
            col1, col2 = st.columns([3, 1])
            with col1:
                topic_q = st.text_input("Quiz topic (optional)", placeholder="e.g., Transformers", key="quiz_topic")
            with col2:
                num_q = st.selectbox("Questions", [2, 4, 6, 8, 10], index=0, key="quiz_num")

            if st.button("‚úÖ Generate Quiz", type="primary", use_container_width=True):
                with st.spinner("Generating quiz..."):
                    r = requests.post(f"{API_BASE}/study/quiz", json={
                        "topic": topic_q or "core concepts",
                        "num_questions": num_q,
                        "context": material_text
                    })
                    if r.status_code == 200:
                        st.session_state.quiz = r.json().get("quiz", [])
                        st.success("‚úÖ Quiz ready!")

            if st.session_state.get("quiz"):
                for i, q in enumerate(st.session_state.quiz):
                    st.markdown(f"**Q{i+1}.** {q.get('question')}")
                    for j, opt in enumerate(q.get("options", [])):
                        if j == q.get("correct_index"):
                            st.markdown(f'<span style="color:#5eead4;">‚úÖ {opt}</span>', unsafe_allow_html=True)
                        else:
                            st.markdown(f'<span style="color:#94a3b8;">‚Ä¢ {opt}</span>', unsafe_allow_html=True)

                    explanation = q.get("explanation", "")
                    if explanation:
                        st.markdown(f"""
                        <details style="margin:1rem 0;">
                            <summary style="color:#5eead4; cursor:pointer; font-weight:600;">üí° Show Explanation</summary>
                            <p style="color:#cbd5e1; margin-top:0.5rem; padding-left:0.5rem;">{explanation}</p>
                        </details>
                        """, unsafe_allow_html=True)
                    st.markdown("---")

        # === 3. Summary ===
        with st.expander("üìù Summary ‚Äì Key Points", expanded=False):
            if st.button("üìù Generate Summary", type="primary", use_container_width=True):
                with st.spinner("Summarizing..."):
                    r = requests.post(f"{API_BASE}/study/summary", json={"context": material_text})
                    if r.status_code == 200:
                        st.markdown("### Summary")
                        st.write(r.json().get("summary", ""))

        # === 4. Concept Explainer ===
        with st.expander("üí° Concept Explainer", expanded=False):
            concept = st.text_input("What do you want explained?", 
                                   placeholder="e.g., Positional Encoding", 
                                   key="explain_concept")
            if st.button("üí° Explain Concept", type="primary", use_container_width=True) and concept:
                with st.spinner("Explaining..."):
                    r = requests.post(f"{API_BASE}/study/explain", 
                                    json={"concept": concept, "context": material_text})
                    if r.status_code == 200:
                        st.markdown(f"### {concept}")
                        st.write(r.json().get("explanation", ""))

        # === 5. Study Schedule ===
        with st.expander("üìÖ Study Schedule ‚Äì Personalized Plan", expanded=False):
            col1, col2 = st.columns(2)
            with col1:
                exam_date = st.date_input("Exam date", value=date.today(), min_value=date.today())
            with col2:
                hours_per_day = st.slider("Hours/day", 1, 8, 4)

            focus_topics = st.text_area("Focus topics (optional)", 
                                       placeholder="e.g., Attention, RNNs", 
                                       height=80)
            topic_list = [t.strip() for t in focus_topics.split(",") if t.strip()]

            if st.button("üìÖ Build Study Schedule", type="primary", use_container_width=True):
                days = (exam_date - date.today()).days
                if days < 1:
                    st.error("‚ùå Pick a future date")
                else:
                    with st.spinner("Planning your study schedule..."):
                        r = requests.post(f"{API_BASE}/study/schedule", json={
                            "exam_date": exam_date.isoformat(),
                            "hours_per_day": hours_per_day,
                            "topics": topic_list or ["all key concepts"],
                            "context": material_text
                        })
                        if r.status_code == 200:
                            st.session_state.schedule = r.json().get("schedule", [])
                            st.success(f"‚úÖ Plan created for {days} days!")

            if st.session_state.get("schedule"):
                st.markdown("### Your Study Schedule")
                for day in st.session_state.schedule:
                    with st.container():
                        st.markdown(f"**{day.get('day')} ‚Äì {day.get('focus')}**")
                        for task in day.get("tasks", []):
                            st.markdown(f"‚Ä¢ {task}")
                        st.caption(f"‚è±Ô∏è {day.get('hours', hours_per_day)} hours")
                        st.markdown("---")

# === TAB 3: Advisor Dashboard ===
if tab3 and st.session_state.advisor_mode:
    with tab3:
        st.markdown("# üéØ Advisor Dashboard")
        st.markdown('<div class="info-box">üë®‚Äçüè´ <strong>Advisor Mode Active</strong> | Monitor escalations and support students | Switch to Student mode in sidebar for chat</div>', unsafe_allow_html=True)
        
        # Dashboard Stats - Clean Tiles
        st.markdown('<p class="section-header">üìä Overview</p>', unsafe_allow_html=True)
        
        try:
            stats_resp = requests.get(f"{API_BASE}/advisor/dashboard/stats", timeout=10)
            if stats_resp.status_code == 200:
                stats = stats_resp.json()
                
                # Stats Grid
                col1, col2, col3, col4, col5 = st.columns(5)
                with col1:
                    st.metric("Total Escalations", stats.get("total_escalations", 0))
                with col2:
                    st.metric("‚è≥ Pending", stats.get("pending", 0))
                with col3:
                    st.metric("üîÑ In Progress", stats.get("in_progress", 0))
                with col4:
                    st.metric("‚úÖ Resolved", stats.get("resolved", 0))
                with col5:
                    st.metric("‚ö†Ô∏è High Risk", stats.get("high_risk_students", 0))
                
                # Visualizations
                st.markdown('<p class="section-header">üìä Analytics</p>', unsafe_allow_html=True)
                
                viz_col1, viz_col2, viz_col3 = st.columns(3)
                
                with viz_col1:
                    st.markdown('<div class="dashboard-card">', unsafe_allow_html=True)
                    # Pie Chart - Status Distribution
                    import plotly.graph_objects as go
                    
                    status_data = {
                        'Pending': stats.get("pending", 0),
                        'In Progress': stats.get("in_progress", 0),
                        'Resolved': stats.get("resolved", 0)
                    }
                    
                    fig_pie = go.Figure(data=[go.Pie(
                        labels=list(status_data.keys()),
                        values=list(status_data.values()),
                        hole=0.4,
                        marker=dict(colors=['#f7931e', '#07407b', '#28a745']),
                        textinfo='label+percent',
                        textposition='auto',
                    )])
                    
                    fig_pie.update_layout(
                        title=dict(text="Status Distribution", font=dict(size=14, color='#07407b', family='Inter')),
                        showlegend=True,
                        height=320,
                        paper_bgcolor='rgba(255,255,255,0)',
                        plot_bgcolor='rgba(255,255,255,0)',
                        font=dict(color='#0b0f3b', size=11, family='Inter'),
                        margin=dict(l=10, r=10, t=40, b=10),
                        legend=dict(orientation="h", yanchor="bottom", y=-0.2, xanchor="center", x=0.5)
                    )
                    
                    st.plotly_chart(fig_pie, use_container_width=True)
                    st.markdown('</div>', unsafe_allow_html=True)
                
                with viz_col2:
                    st.markdown('<div class="dashboard-card">', unsafe_allow_html=True)
                    # Bar Chart - Priority Distribution
                    try:
                        all_esc_resp = requests.get(f"{API_BASE}/advisor/escalations", timeout=10)
                        if all_esc_resp.status_code == 200:
                            all_escalations = all_esc_resp.json()
                            
                            priority_counts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0}
                            for esc in all_escalations:
                                priority = esc.get('priority', 1)
                                priority_counts[priority] = priority_counts.get(priority, 0) + 1
                            
                            fig_bar = go.Figure(data=[go.Bar(
                                x=['‚≠ê', '‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê'],
                                y=[priority_counts[1], priority_counts[2], priority_counts[3], 
                                   priority_counts[4], priority_counts[5]],
                                marker=dict(
                                    color=['#28a745', '#7fcdee', '#f7931e', '#ff6b6b', '#dc3545']
                                ),
                                text=[priority_counts[1], priority_counts[2], priority_counts[3], 
                                      priority_counts[4], priority_counts[5]],
                                textposition='auto',
                            )])
                            
                            fig_bar.update_layout(
                                title=dict(text="Priority Distribution", font=dict(size=14, color='#07407b', family='Inter')),
                                xaxis_title="",
                                yaxis_title="Count",
                                height=320,
                                paper_bgcolor='rgba(255,255,255,0)',
                                plot_bgcolor='rgba(255,255,255,0)',
                                font=dict(color='#0b0f3b', size=11, family='Inter'),
                                xaxis=dict(gridcolor='rgba(7,64,123,0.1)', showgrid=False),
                                yaxis=dict(gridcolor='rgba(7,64,123,0.1)'),
                                margin=dict(l=10, r=10, t=40, b=10)
                            )
                            
                            st.plotly_chart(fig_bar, use_container_width=True)
                        else:
                            st.info("Unable to load priority distribution")
                    except Exception as e:
                        st.info(f"Chart data unavailable: {e}")
                    st.markdown('</div>', unsafe_allow_html=True)
                
                with viz_col3:
                    st.markdown('<div class="dashboard-card">', unsafe_allow_html=True)
                    # Risk Level Distribution
                    try:
                        students_resp = requests.get(f"{API_BASE}/advisor/students", timeout=10)
                        if students_resp.status_code == 200:
                            students = students_resp.json()
                            
                            risk_counts = {'low': 0, 'medium': 0, 'high': 0, 'critical': 0}
                            for student in students:
                                risk = student.get('risk_level', 'low')
                                risk_counts[risk] = risk_counts.get(risk, 0) + 1
                            
                            fig_risk = go.Figure(data=[go.Bar(
                                x=['Low', 'Medium', 'High', 'Critical'],
                                y=[risk_counts['low'], risk_counts['medium'], 
                                   risk_counts['high'], risk_counts['critical']],
                                marker=dict(
                                    color=['#28a745', '#ffc107', '#f7931e', '#dc3545']
                                ),
                                text=[risk_counts['low'], risk_counts['medium'], 
                                      risk_counts['high'], risk_counts['critical']],
                                textposition='auto',
                            )])
                            
                            fig_risk.update_layout(
                                title=dict(text="Student Risk Levels", font=dict(size=14, color='#07407b', family='Inter')),
                                xaxis_title="",
                                yaxis_title="Students",
                                height=320,
                                paper_bgcolor='rgba(255,255,255,0)',
                                plot_bgcolor='rgba(255,255,255,0)',
                                font=dict(color='#0b0f3b', size=11, family='Inter'),
                                xaxis=dict(gridcolor='rgba(7,64,123,0.1)', showgrid=False),
                                yaxis=dict(gridcolor='rgba(7,64,123,0.1)'),
                                margin=dict(l=10, r=10, t=40, b=10)
                            )
                            
                            st.plotly_chart(fig_risk, use_container_width=True)
                        else:
                            st.info("Unable to load risk distribution")
                    except Exception as e:
                        st.info(f"Chart data unavailable: {e}")
                    st.markdown('</div>', unsafe_allow_html=True)
                
        except Exception as e:
            st.error(f"Could not load dashboard stats: {e}")
        
        # Filters
        st.markdown('<p class="section-header">üìã Escalation Queue</p>', unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns(3)
        with col1:
            filter_status = st.selectbox(
                "üîç Filter by Status",
                ["All", "pending", "in_progress", "resolved"],
                key="filter_status"
            )
        with col2:
            filter_priority = st.slider("‚≠ê Min Priority", 1, 5, 1, key="filter_priority")
        with col3:
            if st.button("üîÑ Refresh", use_container_width=True, type="primary"):
                if 'escalations_cache' in st.session_state:
                    del st.session_state['escalations_cache']
                st.rerun()
        
        # Get escalations
        try:
            params = {}
            if filter_status != "All":
                params["status"] = filter_status
            if filter_priority > 1:
                params["priority_min"] = filter_priority
            
            with st.spinner("Loading escalations..."):
                esc_resp = requests.get(f"{API_BASE}/advisor/escalations", params=params, timeout=30)
            
            if esc_resp.status_code == 200:
                escalations = esc_resp.json()
                
                st.caption(f"üí° Debug: Loaded {len(escalations)} escalation(s) from API | Filters: Status={filter_status}, Priority>={filter_priority}")
                
                if not escalations:
                    st.markdown('<div class="info-box">üì≠ <strong>No escalations found</strong> with current filters. Try adjusting your filter settings or refresh the dashboard.</div>', unsafe_allow_html=True)
                else:
                    st.markdown(f'<div style="background:linear-gradient(135deg, #07407b 0%, #0b0f3b 100%); color:white; padding:1rem; border-radius:12px; margin:1rem 0;"><h3 style="margin:0; color:white;">üìã {len(escalations)} Escalation(s)</h3></div>', unsafe_allow_html=True)
                    
                    # Display each escalation
                    for esc in escalations:
                        with st.expander(
                            f"üîî [{esc['status'].upper()}] Student: {esc['student_id']} | "
                            f"Priority: {'‚≠ê' * esc.get('priority', 1)} | "
                            f"{esc['created_at'][:10]}",
                            expanded=(esc['status'] == 'pending')
                        ):
                            # Two column layout
                            col_left, col_right = st.columns([2, 1])
                            
                            with col_left:
                                # Question and Response
                                st.markdown("#### üí¨ Student Question")
                                st.markdown(f'<div style="background:#F8F9FA; padding:1.2rem; border-radius:12px; border-left:5px solid #07407b; color:#0b0f3b; box-shadow: 0 2px 8px rgba(7,64,123,0.08);">{esc["question"]}</div>', 
                                          unsafe_allow_html=True)
                                
                                st.markdown("#### ü§ñ AI Response")
                                st.markdown(f'<div style="background:white; padding:1.2rem; border-radius:12px; border:1px solid #E9ECEF; color:#0b0f3b; box-shadow: 0 2px 8px rgba(7,64,123,0.06);">{esc["ai_response"]}</div>', 
                                          unsafe_allow_html=True)
                                
                                st.markdown("#### üìù Escalation Reason")
                                st.markdown(f'<div class="warning-box">‚ö†Ô∏è <strong>{esc["escalation_reason"]}</strong></div>', unsafe_allow_html=True)
                                
                                # Conversation History
                                if esc.get("conversation_history"):
                                    show_history = st.checkbox("üí¨ View Full Conversation History", key=f"history_{esc['id']}")
                                    if show_history:
                                        st.markdown("---")
                                        for msg in esc["conversation_history"]:
                                            role = msg.get("role", "unknown")
                                            content = msg.get("content", "")
                                            timestamp = msg.get("timestamp", "")[:16]
                                            
                                            if role == "user":
                                                st.markdown(f'**üéì Student** <small style="color:#6C757D;">({timestamp})</small>', unsafe_allow_html=True)
                                                st.markdown(f'<div style="background:linear-gradient(135deg, #7fcdee20 0%, #7fcdee10 100%); padding:0.8rem; border-radius:8px; margin-bottom:0.5rem; border-left:3px solid #7fcdee; color:#0b0f3b;">{content}</div>', 
                                                          unsafe_allow_html=True)
                                            else:
                                                st.markdown(f'**ü§ñ AI** <small style="color:#6C757D;">({timestamp})</small>', unsafe_allow_html=True)
                                                st.markdown(f'<div style="background:#F8F9FA; padding:0.8rem; border-radius:8px; margin-bottom:0.5rem; border-left:3px solid #ADB5BD; color:#0b0f3b;">{content}</div>', 
                                                          unsafe_allow_html=True)
                                        st.markdown("---")
                                
                                # Advisor Notes
                                if esc.get("advisor_notes"):
                                    st.markdown("#### üìå Advisor Notes")
                                    for note in esc["advisor_notes"]:
                                        # Handle both string format (old) and dict format (new)
                                        if isinstance(note, str):
                                            note_text = note
                                            note_time = ""
                                        elif isinstance(note, dict):
                                            note_text = note.get("note", "")
                                            note_time = note.get("timestamp", "")[:16]
                                        else:
                                            continue
                                        
                                        if note_time:
                                            st.markdown(f'- {note_text} <small style="color:#64748b;">({note_time})</small>', 
                                                      unsafe_allow_html=True)
                                        else:
                                            st.markdown(f'- {note_text}', unsafe_allow_html=True)
                            
                            with col_right:
                                # Student Profile Card
                                st.markdown("#### üë§ Student Profile")
                                try:
                                    profile_resp = requests.get(
                                        f"{API_BASE}/advisor/students/{esc['student_id']}", 
                                        timeout=5
                                    )
                                    if profile_resp.status_code == 200:
                                        profile = profile_resp.json()
                                        
                                        # Risk level badge
                                        risk_level = profile.get("risk_level", "low")
                                        risk_colors = {
                                            "low": "#28a745",
                                            "medium": "#ffc107",
                                            "high": "#f7931e",
                                            "critical": "#dc3545"
                                        }
                                        risk_color = risk_colors.get(risk_level, "#6C757D")
                                        
                                        st.markdown(f"""
                                        <div style="background:white; padding:1.2rem; border-radius:12px; border:2px solid #E9ECEF; word-wrap:break-word; overflow-wrap:break-word; box-shadow: 0 2px 8px rgba(7,64,123,0.08);">
                                            <p style="margin:0.5rem 0; color:#0b0f3b; word-wrap:break-word;"><strong>Name:</strong><br/><span style="color:#07407b; font-weight:600;">{profile.get('name', 'Unknown')}</span></p>
                                            <p style="margin:0.5rem 0; color:#0b0f3b;"><strong>Major:</strong><br/><span style="color:#6C757D;">{profile.get('major', 'Undeclared')}</span></p>
                                            <p style="margin:0.5rem 0; color:#0b0f3b;"><strong>GPA:</strong> <span style="color:#07407b; font-weight:600; font-size:1.1rem;">{profile.get('gpa', 'N/A')}</span></p>
                                            <p style="margin:0.5rem 0; color:#0b0f3b;"><strong>Risk Level:</strong> <span style="background:{risk_color}; color:white; padding:0.3rem 0.6rem; border-radius:6px; font-weight:bold; font-size:0.85rem;">{risk_level.upper()}</span></p>
                                            <p style="margin:0.5rem 0; color:#0b0f3b;"><strong>Total Escalations:</strong> <span style="color:#07407b; font-weight:600;">{profile.get('total_escalations', 0)}</span></p>
                                            <p style="margin:0.5rem 0; color:#0b0f3b;"><strong>Last Interaction:</strong><br/><span style="color:#6C757D;">{profile.get('last_interaction', 'N/A')[:10]}</span></p>
                                        </div>
                                        """, unsafe_allow_html=True)
                                        
                                        # Show completed courses
                                        if profile.get("completed_courses"):
                                            st.markdown("**Completed Courses:**")
                                            for course in profile.get("completed_courses", [])[:5]:
                                                st.caption(f"‚úì {course}")
                                        
                                        if profile.get("current_courses"):
                                            st.markdown("**Current Courses:**")
                                            for course in profile.get("current_courses", [])[:5]:
                                                st.caption(f"üìö {course}")
                                    else:
                                        st.warning("Could not load student profile")
                                except Exception as e:
                                    st.error(f"Error loading profile: {e}")
                            
                            st.markdown("---")
                            
                            # Action Section
                            st.markdown("#### üéØ Take Action")
                            
                            action_col1, action_col2 = st.columns(2)
                            
                            with action_col1:
                                new_status = st.selectbox(
                                    "Update Status",
                                    ["pending", "in_progress", "resolved", "closed"],
                                    index=["pending", "in_progress", "resolved", "closed"].index(esc.get("status", "pending")),
                                    key=f"status_{esc['id']}"
                                )
                            
                            with action_col2:
                                new_priority = st.selectbox(
                                    "Priority",
                                    [1, 2, 3, 4, 5],
                                    index=esc.get("priority", 1) - 1,
                                    key=f"priority_{esc['id']}"
                                )
                            
                            advisor_note = st.text_area(
                                "Add Note for Follow-up",
                                placeholder="Enter your notes, recommendations, or next steps...",
                                key=f"note_{esc['id']}",
                                height=100
                            )
                            
                            assigned_to = st.text_input(
                                "Assign To (Advisor Name)",
                                value=esc.get("assigned_to", ""),
                                key=f"assign_{esc['id']}"
                            )
                            
                            if st.button("üíæ Update Escalation", key=f"update_{esc['id']}", type="primary"):
                                try:
                                    update_data = {}
                                    if new_status != esc.get("status"):
                                        update_data["status"] = new_status
                                    if advisor_note:
                                        update_data["note"] = advisor_note
                                    if assigned_to != esc.get("assigned_to", ""):
                                        update_data["assigned_to"] = assigned_to
                                    if new_priority != esc.get("priority", 1):
                                        update_data["priority"] = new_priority
                                    
                                    if update_data:
                                        update_resp = requests.patch(
                                            f"{API_BASE}/advisor/escalations/{esc['id']}",
                                            json=update_data,
                                            timeout=10
                                        )
                                        if update_resp.status_code == 200:
                                            st.success("‚úÖ Escalation updated successfully!")
                                            time.sleep(1)
                                            st.rerun()
                                        else:
                                            st.error(f"Failed to update: {update_resp.text}")
                                    else:
                                        st.info("No changes to save")
                                except Exception as e:
                                    st.error(f"Error updating escalation: {e}")
                            
                            # ========== AI ASSIST TOOLS ==========
                            st.markdown("---")
                            st.markdown("#### ü§ñ AI Assist Tools")
                            st.markdown("Generate AI-powered content to help respond to this student:")
                            
                            # Tool selector
                            assist_tool = st.selectbox(
                                "Select Tool",
                                [
                                    "üìß Outreach Email",
                                    "üìÖ Meeting Invitation",
                                    "üìù Session Summary",
                                    "üìä Academic Recovery Plan",
                                    "üìã Guidance Notes"
                                ],
                                key=f"tool_select_{esc['id']}"
                            )
                            
                            # Additional inputs for specific tools
                            additional_input = ""
                            if "Session Summary" in assist_tool:
                                additional_input = st.text_area(
                                    "Additional Session Notes (optional)",
                                    placeholder="Add any notes from your conversation with the student...",
                                    height=80,
                                    key=f"session_notes_{esc['id']}"
                                )
                            elif "Guidance Notes" in assist_tool:
                                additional_input = st.text_area(
                                    "Relevant Policy Context (optional)",
                                    placeholder="Add any specific SUNY policies or requirements...",
                                    height=80,
                                    key=f"policy_context_{esc['id']}"
                                )
                            
                            tool_col1, tool_col2 = st.columns([1, 1])
                            
                            with tool_col1:
                                if st.button("‚ú® Generate", key=f"generate_{esc['id']}", type="secondary"):
                                    # Determine which tool to call
                                    endpoint_map = {
                                        "üìß Outreach Email": "generate-email",
                                        "üìÖ Meeting Invitation": "generate-meeting",
                                        "üìù Session Summary": "generate-summary",
                                        "üìä Academic Recovery Plan": "generate-recovery-plan",
                                        "üìã Guidance Notes": "generate-guidance"
                                    }
                                    
                                    endpoint = endpoint_map[assist_tool]
                                    
                                    with st.spinner(f"ü§ñ Generating {assist_tool.split(' ', 1)[1]}..."):
                                        try:
                                            # Prepare request data
                                            req_data = {}
                                            if "Session Summary" in assist_tool and additional_input:
                                                req_data = {"notes": additional_input}
                                            elif "Guidance Notes" in assist_tool and additional_input:
                                                req_data = {"policy_context": additional_input}
                                            
                                            # Make API call
                                            gen_resp = requests.post(
                                                f"{API_BASE}/advisor/escalations/{esc['id']}/{endpoint}",
                                                json=req_data if req_data else None,
                                                timeout=30
                                            )
                                            
                                            if gen_resp.status_code == 200:
                                                result = gen_resp.json()
                                                content_key = list(result.keys())[1]  # Skip 'status', get content key
                                                generated_content = result.get(content_key, "")
                                                
                                                # Store in session state for display
                                                st.session_state[f"generated_content_{esc['id']}"] = generated_content
                                                st.success(f"‚úÖ {assist_tool.split(' ', 1)[1]} generated successfully!")
                                                time.sleep(0.5)
                                                st.rerun()
                                            else:
                                                st.error(f"Generation failed: {gen_resp.text}")
                                        except Exception as e:
                                            st.error(f"Error generating content: {e}")
                            
                            # Display generated content
                            if st.session_state.get(f"generated_content_{esc['id']}"):
                                st.markdown("---")
                                st.markdown("##### üìÑ Generated Content")
                                
                                generated_text = st.session_state[f"generated_content_{esc['id']}"]
                                
                                # Display in a nice text area for editing
                                edited_content = st.text_area(
                                    "Review and edit as needed:",
                                    value=generated_text,
                                    height=300,
                                    key=f"edit_content_{esc['id']}"
                                )
                                
                                action_col_a, action_col_b, action_col_c = st.columns(3)
                                
                                with action_col_a:
                                    if st.button("üìã Copy to Clipboard", key=f"copy_{esc['id']}"):
                                        # Use st.code to make it easy to copy
                                        st.code(edited_content, language=None)
                                        st.info("üëÜ Select text above and copy (Cmd/Ctrl+C)")
                                
                                with action_col_b:
                                    # Download as text file
                                    st.download_button(
                                        label="‚¨áÔ∏è Download",
                                        data=edited_content,
                                        file_name=f"{assist_tool.replace(' ', '_').replace('üìß', '').replace('üìÖ', '').replace('üìù', '').replace('üìä', '').replace('üìã', '').strip()}_{esc['student_id']}.txt",
                                        mime="text/plain",
                                        key=f"download_{esc['id']}"
                                    )
                                
                                with action_col_c:
                                    if st.button("üóëÔ∏è Clear", key=f"clear_gen_{esc['id']}"):
                                        del st.session_state[f"generated_content_{esc['id']}"]
                                        st.rerun()
            else:
                st.error(f"Failed to load escalations: {esc_resp.text}")
        
        except Exception as e:
            st.error(f"Error loading escalations: {e}")
        
        st.markdown("---")
        
        # Repeat Students Section
        st.markdown("### üö® Students Needing Attention")
        try:
            stats_resp = requests.get(f"{API_BASE}/advisor/dashboard/stats", timeout=10)
            if stats_resp.status_code == 200:
                stats = stats_resp.json()
                repeat_students = stats.get("repeat_students", [])
                
                if repeat_students:
                    for student in repeat_students[:5]:
                        with st.expander(
                            f"‚ö†Ô∏è {student['name']} ({student['student_id']}) - "
                            f"{student['escalation_count']} escalations - "
                            f"Risk: {student['risk_level'].upper()}"
                        ):
                            st.write(f"**Student ID:** {student['student_id']}")
                            st.write(f"**Name:** {student['name']}")
                            st.write(f"**Total Escalations:** {student['escalation_count']}")
                            st.write(f"**Risk Level:** {student['risk_level']}")
                            
                            if st.button(f"View All Escalations", key=f"view_all_{student['student_id']}"):
                                # This would filter to show only this student's escalations
                                st.info(f"Filtering for student {student['student_id']}...")
                else:
                    st.success("‚úÖ No students with multiple escalations")
        except:
            pass

# === TAB 4: Administrator Analytics Dashboard ===
if tab4 and st.session_state.admin_mode:
    with tab4:
        st.markdown("# üìä Administrator Analytics")
        st.markdown('<div class="info-box">üìä <strong>Administrator Mode Active</strong> | Viewing comprehensive system analytics | Switch modes in sidebar</div>', unsafe_allow_html=True)
        
        # === OVERVIEW METRICS ===
        st.markdown('<p class="section-header">üìà System Overview</p>', unsafe_allow_html=True)
        
        try:
            overview_resp = requests.get(f"{API_BASE}/admin/analytics/overview", timeout=30)
            if overview_resp.status_code == 200:
                overview = overview_resp.json()
                
                # Key Metrics Row
                col1, col2, col3, col4, col5 = st.columns(5)
                with col1:
                    st.metric("Total Questions", f"{overview.get('total_questions', 0):,}")
                with col2:
                    st.metric("Active Students (30d)", overview.get('active_users_month', 0))
                with col3:
                    st.metric("Escalation Rate", f"{overview.get('escalation_rate', 0)}%")
                with col4:
                    st.metric("Accuracy Rate", f"{overview.get('accuracy_rate', 0)}%", 
                             delta=None if overview.get('accuracy_rate', 0) >= 95 else "Low")
                with col5:
                    st.metric("Avg Satisfaction", f"{overview.get('avg_satisfaction', 0)}/5",
                             delta="Good" if overview.get('avg_satisfaction', 0) >= 4 else "Needs Improvement")
                
                col6, col7, col8, col9 = st.columns(4)
                with col6:
                    st.metric("Total Students", overview.get('total_students', 0))
                with col7:
                    st.metric("Active (7d)", overview.get('active_users_week', 0))
                with col8:
                    st.metric("High Risk Students", overview.get('high_risk_students', 0))
                with col9:
                    st.metric("Flagged Responses", overview.get('flagged_responses', 0))
                
                st.markdown("---")
                
            else:
                st.error("Failed to load overview metrics")
                
        except Exception as e:
            st.error(f"Error loading overview: {e}")
        
        # === USAGE & ENGAGEMENT SECTION ===
        st.markdown('<p class="section-header">üìä Usage & Engagement</p>', unsafe_allow_html=True)
        
        try:
            # Get usage trends
            trends_resp = requests.get(f"{API_BASE}/admin/analytics/usage-trends?days=30", timeout=30)
            topics_resp = requests.get(f"{API_BASE}/admin/analytics/top-topics?limit=10", timeout=30)
            peak_hours_resp = requests.get(f"{API_BASE}/admin/analytics/peak-hours", timeout=30)
            
            if trends_resp.status_code == 200 and topics_resp.status_code == 200:
                trends_data = trends_resp.json()
                topics_data = topics_resp.json()
                
                # Row 1: Usage Trends and Top Topics
                col_left, col_right = st.columns(2)
                
                with col_left:
                    st.markdown('<div class="dashboard-card">', unsafe_allow_html=True)
                    st.markdown("**üìà Questions Over Time (30 Days)**")
                    import plotly.graph_objects as go
                    
                    trends = trends_data.get("trends", [])
                    dates = [t["date"] for t in trends]
                    questions = [t["questions"] for t in trends]
                    users = [t["active_users"] for t in trends]
                    
                    fig_trends = go.Figure()
                    fig_trends.add_trace(go.Scatter(
                        x=dates, y=questions, mode='lines+markers',
                        name='Questions', line=dict(color='#07407b', width=3),
                        marker=dict(size=5), fill='tozeroy', fillcolor='rgba(7,64,123,0.1)'
                    ))
                    fig_trends.add_trace(go.Scatter(
                        x=dates, y=users, mode='lines+markers',
                        name='Active Users', line=dict(color='#f7931e', width=3),
                        marker=dict(size=5), yaxis='y2'
                    ))
                    
                    fig_trends.update_layout(
                        height=370,
                        paper_bgcolor='rgba(255,255,255,0)',
                        plot_bgcolor='rgba(255,255,255,0)',
                        font=dict(color='#0b0f3b', size=11, family='Inter'),
                        xaxis=dict(gridcolor='rgba(7,64,123,0.1)', title=""),
                        yaxis=dict(gridcolor='rgba(7,64,123,0.1)', title="Questions", side='left'),
                        yaxis2=dict(gridcolor='rgba(247,147,30,0.1)', title="Users", 
                                   overlaying='y', side='right'),
                        legend=dict(x=0.01, y=0.99, bgcolor='rgba(255,255,255,0.8)'),
                        margin=dict(l=10, r=10, t=10, b=10),
                        hovermode='x unified'
                    )
                    
                    st.plotly_chart(fig_trends, use_container_width=True)
                    st.markdown('</div>', unsafe_allow_html=True)
                
                with col_right:
                    st.markdown('<div class="dashboard-card">', unsafe_allow_html=True)
                    st.markdown("**üîù Most Asked Topics**")
                    
                    top_topics = topics_data.get("top_topics", [])
                    topics_names = [t["topic"] for t in top_topics]
                    topics_counts = [t["count"] for t in top_topics]
                    
                    fig_topics = go.Figure(data=[go.Bar(
                        y=topics_names[::-1],
                        x=topics_counts[::-1],
                        orientation='h',
                        marker=dict(
                            color=topics_counts[::-1],
                            colorscale=[[0, '#7fcdee'], [0.5, '#07407b'], [1, '#f7931e']],
                            showscale=False
                        ),
                        text=topics_counts[::-1],
                        textposition='auto',
                        hovertemplate='<b>%{y}</b><br>Questions: %{x}<extra></extra>'
                    )])
                    
                    fig_topics.update_layout(
                        height=370,
                        paper_bgcolor='rgba(255,255,255,0)',
                        plot_bgcolor='rgba(255,255,255,0)',
                        font=dict(color='#0b0f3b', size=10, family='Inter'),
                        xaxis=dict(gridcolor='rgba(7,64,123,0.1)', title=""),
                        yaxis=dict(title=""),
                        margin=dict(l=10, r=10, t=10, b=10)
                    )
                    
                    st.plotly_chart(fig_topics, use_container_width=True)
                    st.markdown('</div>', unsafe_allow_html=True)
                
                # Row 2: Peak Hours Heatmap
                if peak_hours_resp.status_code == 200:
                    st.markdown("### üïê Peak Usage Hours")
                    peak_data = peak_hours_resp.json()
                    heatmap_data = peak_data.get("heatmap_data", [])
                    
                    # Transform data for heatmap
                    days_order = peak_data.get("days_order", [])
                    hours_range = peak_data.get("hours_range", [])
                    
                    # Create matrix
                    import numpy as np
                    matrix = []
                    for day in days_order:
                        day_data = [d["count"] for d in heatmap_data if d["day"] == day]
                        matrix.append(day_data)
                    
                    fig_heatmap = go.Figure(data=go.Heatmap(
                        z=matrix,
                        x=[f"{h}:00" for h in hours_range],
                        y=days_order,
                        colorscale=[[0, '#1e293b'], [0.5, '#3b82f6'], [1, '#5eead4']],
                        hovertemplate='%{y}<br>Hour: %{x}<br>Questions: %{z}<extra></extra>'
                    ))
                    
                    fig_heatmap.update_layout(
                        height=350,
                        paper_bgcolor='rgba(0,0,0,0)',
                        plot_bgcolor='rgba(0,0,0,0)',
                        font=dict(color='#e2e8f0', size=10),
                        xaxis=dict(title="Hour of Day", side='bottom'),
                        yaxis=dict(title="Day of Week"),
                        margin=dict(l=20, r=20, t=20, b=20)
                    )
                    
                    st.plotly_chart(fig_heatmap, use_container_width=True)
                    
                    # Insights
                    st.info("üí° **Insight**: Use this heatmap to identify peak hours and allocate advisor resources accordingly.")
                
        except Exception as e:
            st.error(f"Error loading usage & engagement data: {e}")
        
        st.markdown("---")
        
        # === QUALITY & ACCURACY MONITORING ===
        st.markdown('<p class="section-header">‚úÖ Quality & Accuracy</p>', unsafe_allow_html=True)
        
        try:
            accuracy_resp = requests.get(f"{API_BASE}/admin/analytics/accuracy-monitoring", timeout=30)
            satisfaction_resp = requests.get(f"{API_BASE}/admin/analytics/satisfaction-trends", timeout=30)
            
            if accuracy_resp.status_code == 200 and satisfaction_resp.status_code == 200:
                accuracy_data = accuracy_resp.json()
                satisfaction_data = satisfaction_resp.json()
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.markdown("### üéØ Accuracy Over Time")
                    
                    accuracy_trend = accuracy_data.get("accuracy_trend", [])
                    weeks = [t["week"] for t in accuracy_trend]
                    accuracy = [t["accuracy"] for t in accuracy_trend]
                    
                    fig_accuracy = go.Figure()
                    fig_accuracy.add_trace(go.Scatter(
                        x=weeks, y=accuracy, mode='lines+markers',
                        name='Accuracy Rate', line=dict(color='#10b981', width=3),
                        marker=dict(size=8), fill='tozeroy',
                        fillcolor='rgba(16, 185, 129, 0.2)'
                    ))
                    fig_accuracy.add_hline(y=95, line_dash="dash", line_color="yellow", 
                                          annotation_text="Target: 95%")
                    
                    fig_accuracy.update_layout(
                        height=350,
                        paper_bgcolor='rgba(0,0,0,0)',
                        plot_bgcolor='rgba(0,0,0,0)',
                        font=dict(color='#e2e8f0', size=12),
                        xaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Week"),
                        yaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Accuracy %", range=[85, 100]),
                        margin=dict(l=20, r=20, t=20, b=20),
                        showlegend=False
                    )
                    
                    st.plotly_chart(fig_accuracy, use_container_width=True)
                    
                    st.metric("Overall Accuracy", f"{accuracy_data.get('overall_accuracy', 0)}%")
                
                with col2:
                    st.markdown("### ‚≠ê Satisfaction Rating Distribution")
                    
                    rating_dist = satisfaction_data.get("rating_distribution", [])
                    ratings = [r["rating"] for r in rating_dist]
                    counts = [r["count"] for r in rating_dist]
                    
                    fig_satisfaction = go.Figure(data=[go.Bar(
                        x=[f"{r} ‚≠ê" for r in ratings],
                        y=counts,
                        marker=dict(
                            color=counts,
                            colorscale=[[0, '#ef4444'], [0.5, '#f59e0b'], [1, '#10b981']],
                            showscale=False
                        ),
                        text=counts,
                        textposition='auto',
                        hovertemplate='Rating: %{x}<br>Count: %{y}<extra></extra>'
                    )])
                    
                    fig_satisfaction.update_layout(
                        height=350,
                        paper_bgcolor='rgba(0,0,0,0)',
                        plot_bgcolor='rgba(0,0,0,0)',
                        font=dict(color='#e2e8f0', size=12),
                        xaxis=dict(title="Rating"),
                        yaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Number of Responses"),
                        margin=dict(l=20, r=20, t=20, b=20)
                    )
                    
                    st.plotly_chart(fig_satisfaction, use_container_width=True)
                    
                    st.metric("Average Satisfaction", f"{satisfaction_data.get('overall_avg', 0)}/5")
                
                # Common Issues
                st.markdown("### ‚ö†Ô∏è Common Flagged Issues")
                common_issues = accuracy_data.get("common_issues", [])
                
                if common_issues:
                    col1, col2 = st.columns([2, 1])
                    with col1:
                        issue_names = [i["issue"] for i in common_issues[:7]]
                        issue_counts = [i["count"] for i in common_issues[:7]]
                        
                        fig_issues = go.Figure(data=[go.Bar(
                            y=issue_names[::-1],
                            x=issue_counts[::-1],
                            orientation='h',
                            marker=dict(color='#ef4444'),
                            text=issue_counts[::-1],
                            textposition='auto'
                        )])
                        
                        fig_issues.update_layout(
                            height=300,
                            paper_bgcolor='rgba(0,0,0,0)',
                            plot_bgcolor='rgba(0,0,0,0)',
                            font=dict(color='#e2e8f0', size=11),
                            xaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Occurrences"),
                            yaxis=dict(title=""),
                            margin=dict(l=20, r=20, t=20, b=20)
                        )
                        
                        st.plotly_chart(fig_issues, use_container_width=True)
                    
                    with col2:
                        st.markdown("#### üìã Action Items")
                        st.markdown("- Review flagged topics for knowledge base gaps")
                        st.markdown("- Update outdated policy documents")
                        st.markdown("- Improve AI prompts for clarity")
                        st.markdown("- Train on edge cases")
                
        except Exception as e:
            st.error(f"Error loading quality & accuracy data: {e}")
        
        st.markdown("---")
        
        # === STUDENT BEHAVIOR INSIGHTS ===
        st.markdown('<p class="section-header">üë• Student Behavior</p>', unsafe_allow_html=True)
        
        try:
            behavior_resp = requests.get(f"{API_BASE}/admin/analytics/student-behavior", timeout=30)
            
            if behavior_resp.status_code == 200:
                behavior_data = behavior_resp.json()
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.markdown("### üîÑ Students Repeatedly Seeking Help")
                    
                    repeat_students = behavior_data.get("repeat_help_seekers", [])
                    
                    if repeat_students:
                        for student in repeat_students[:10]:
                            risk_colors = {
                                "low": "üü¢",
                                "medium": "üü°",
                                "high": "üü†",
                                "critical": "üî¥"
                            }
                            risk_icon = risk_colors.get(student.get("risk_level", "low"), "‚ö™")
                            
                            st.markdown(f"""
                            <div style="background:rgba(30,41,59,0.9); padding:0.8rem; border-radius:8px; margin:0.5rem 0; border-left:4px solid #5eead4;">
                                <strong>{risk_icon} {student.get('name', 'Unknown')}</strong> ({student.get('student_id', 'N/A')})<br>
                                <span style="color:#94a3b8;">Questions: {student.get('question_count', 0)} | Risk: {student.get('risk_level', 'low').upper()}</span>
                            </div>
                            """, unsafe_allow_html=True)
                    else:
                        st.info("No repeat help-seekers identified")
                
                with col2:
                    st.markdown("### ü§î High Confusion Areas")
                    
                    confusion_areas = behavior_data.get("confusion_areas", [])
                    
                    if confusion_areas:
                        topics = [c["topic"] for c in confusion_areas[:8]]
                        scores = [c["confusion_score"] for c in confusion_areas[:8]]
                        
                        fig_confusion = go.Figure(data=[go.Bar(
                            y=topics[::-1],
                            x=scores[::-1],
                            orientation='h',
                            marker=dict(
                                color=scores[::-1],
                                colorscale=[[0, '#f59e0b'], [1, '#ef4444']],
                                showscale=False
                            ),
                            text=[f"{s:.1f}" for s in scores[::-1]],
                            textposition='auto',
                            hovertemplate='<b>%{y}</b><br>Confusion Score: %{x:.2f}<extra></extra>'
                        )])
                        
                        fig_confusion.update_layout(
                            height=350,
                            paper_bgcolor='rgba(0,0,0,0)',
                            plot_bgcolor='rgba(0,0,0,0)',
                            font=dict(color='#e2e8f0', size=11),
                            xaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Confusion Score"),
                            yaxis=dict(title=""),
                            margin=dict(l=20, r=20, t=20, b=20)
                        )
                        
                        st.plotly_chart(fig_confusion, use_container_width=True)
                        
                        st.caption("üí° Confusion Score = (5 - Avg Rating) √ó Avg Conversation Length")
                
                # High Friction Topics
                st.markdown("### üî• High Friction Topics (Long Conversations)")
                
                high_friction = behavior_data.get("high_friction_topics", [])
                
                if high_friction:
                    friction_topics = [t["topic"] for t in high_friction[:10]]
                    friction_lengths = [t["avg_conversation_length"] for t in high_friction[:10]]
                    
                    fig_friction = go.Figure(data=[go.Scatter(
                        x=friction_topics,
                        y=friction_lengths,
                        mode='markers',
                        marker=dict(
                            size=[t["question_count"] for t in high_friction[:10]],
                            sizemode='area',
                            sizeref=2.*max([t["question_count"] for t in high_friction[:10]])/(40.**2),
                            sizemin=4,
                            color=friction_lengths,
                            colorscale=[[0, '#3b82f6'], [1, '#ef4444']],
                            showscale=True,
                            colorbar=dict(title="Avg Length")
                        ),
                        text=friction_topics,
                        hovertemplate='<b>%{text}</b><br>Avg Conversation: %{y:.1f} exchanges<extra></extra>'
                    )])
                    
                    fig_friction.update_layout(
                        height=350,
                        paper_bgcolor='rgba(0,0,0,0)',
                        plot_bgcolor='rgba(0,0,0,0)',
                        font=dict(color='#e2e8f0', size=11),
                        xaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Topic", tickangle=-45),
                        yaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Avg Conversation Length"),
                        margin=dict(l=20, r=20, t=20, b=80)
                    )
                    
                    st.plotly_chart(fig_friction, use_container_width=True)
                    
                    st.info("üí° **Insight**: Topics with longer conversations may need clearer documentation or additional training data.")
                
        except Exception as e:
            st.error(f"Error loading student behavior data: {e}")
        
        st.markdown("---")
        
        # === ESCALATION ANALYSIS ===
        st.markdown('<p class="section-header">üö® Escalation Analysis</p>', unsafe_allow_html=True)
        
        try:
            escalation_resp = requests.get(f"{API_BASE}/admin/analytics/escalation-analysis", timeout=30)
            
            if escalation_resp.status_code == 200:
                escalation_data = escalation_resp.json()
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.markdown("### üìä Escalations by Topic")
                    
                    esc_by_topic = escalation_data.get("escalation_by_topic", [])
                    
                    if esc_by_topic:
                        topics = [e["topic"] for e in esc_by_topic]
                        counts = [e["count"] for e in esc_by_topic]
                        
                        fig_esc_topics = go.Figure(data=[go.Pie(
                            labels=topics,
                            values=counts,
                            hole=0.4,
                            marker=dict(colors=['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899']),
                            textinfo='label+percent',
                            textposition='auto',
                            hovertemplate='<b>%{label}</b><br>Count: %{value}<br>Percentage: %{percent}<extra></extra>'
                        )])
                        
                        fig_esc_topics.update_layout(
                            height=350,
                            paper_bgcolor='rgba(0,0,0,0)',
                            plot_bgcolor='rgba(0,0,0,0)',
                            font=dict(color='#e2e8f0', size=11),
                            showlegend=True,
                            legend=dict(orientation="v", yanchor="middle", y=0.5),
                            margin=dict(l=20, r=20, t=20, b=20)
                        )
                        
                        st.plotly_chart(fig_esc_topics, use_container_width=True)
                
                with col2:
                    st.markdown("### üîç Escalation Reasons")
                    
                    esc_reasons = escalation_data.get("escalation_reasons", [])
                    
                    if esc_reasons:
                        # Simplify reason text for display
                        reasons = [r["reason"].split(":")[1].strip() if ":" in r["reason"] else r["reason"] for r in esc_reasons[:8]]
                        counts = [r["count"] for r in esc_reasons[:8]]
                        
                        fig_reasons = go.Figure(data=[go.Bar(
                            x=counts,
                            y=reasons[::-1],
                            orientation='h',
                            marker=dict(color='#f59e0b'),
                            text=counts[::-1],
                            textposition='auto'
                        )])
                        
                        fig_reasons.update_layout(
                            height=350,
                            paper_bgcolor='rgba(0,0,0,0)',
                            plot_bgcolor='rgba(0,0,0,0)',
                            font=dict(color='#e2e8f0', size=10),
                            xaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Count"),
                            yaxis=dict(title=""),
                            margin=dict(l=20, r=20, t=20, b=20)
                        )
                        
                        st.plotly_chart(fig_reasons, use_container_width=True)
                
                # Escalation Rate Trend
                st.markdown("### üìà Escalation Rate Trend")
                
                esc_trend = escalation_data.get("escalation_rate_trend", [])
                
                if esc_trend:
                    weeks = [t["week"] for t in esc_trend]
                    rates = [t["rate"] for t in esc_trend]
                    
                    fig_esc_trend = go.Figure()
                    fig_esc_trend.add_trace(go.Scatter(
                        x=weeks, y=rates, mode='lines+markers',
                        name='Escalation Rate', line=dict(color='#f59e0b', width=3),
                        marker=dict(size=8), fill='tozeroy',
                        fillcolor='rgba(245, 158, 11, 0.2)',
                        hovertemplate='Week: %{x}<br>Rate: %{y:.2f}%<extra></extra>'
                    ))
                    fig_esc_trend.add_hline(y=10, line_dash="dash", line_color="red", 
                                           annotation_text="Target: < 10%")
                    
                    fig_esc_trend.update_layout(
                        height=300,
                        paper_bgcolor='rgba(0,0,0,0)',
                        plot_bgcolor='rgba(0,0,0,0)',
                        font=dict(color='#e2e8f0', size=12),
                        xaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Week"),
                        yaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Escalation Rate %"),
                        margin=dict(l=20, r=20, t=20, b=20),
                        showlegend=False
                    )
                    
                    st.plotly_chart(fig_esc_trend, use_container_width=True)
                
        except Exception as e:
            st.error(f"Error loading escalation analysis: {e}")
        
        st.markdown("---")
        
        # === RISK IDENTIFICATION ===
        st.markdown('<p class="section-header">‚ö†Ô∏è Risk Identification</p>', unsafe_allow_html=True)
        
        try:
            risk_resp = requests.get(f"{API_BASE}/admin/analytics/risk-identification", timeout=30)
            
            if risk_resp.status_code == 200:
                risk_data = risk_resp.json()
                
                col1, col2 = st.columns([1, 2])
                
                with col1:
                    st.markdown("### üìä Risk Level Distribution")
                    
                    risk_dist = risk_data.get("risk_distribution", [])
                    levels = [r["level"].capitalize() for r in risk_dist]
                    counts = [r["count"] for r in risk_dist]
                    
                    colors_map = {
                        "Low": "#10b981",
                        "Medium": "#f59e0b",
                        "High": "#ef4444",
                        "Critical": "#dc2626"
                    }
                    colors = [colors_map.get(l, "#64748b") for l in levels]
                    
                    fig_risk_dist = go.Figure(data=[go.Pie(
                        labels=levels,
                        values=counts,
                        hole=0.5,
                        marker=dict(colors=colors),
                        textinfo='label+value',
                        textposition='auto',
                        hovertemplate='<b>%{label}</b><br>Students: %{value}<br>Percentage: %{percent}<extra></extra>'
                    )])
                    
                    fig_risk_dist.update_layout(
                        height=350,
                        paper_bgcolor='rgba(0,0,0,0)',
                        plot_bgcolor='rgba(0,0,0,0)',
                        font=dict(color='#e2e8f0', size=12),
                        showlegend=True,
                        margin=dict(l=20, r=20, t=20, b=20)
                    )
                    
                    st.plotly_chart(fig_risk_dist, use_container_width=True)
                
                with col2:
                    st.markdown("### üéì Risk Patterns by Major")
                    
                    major_patterns = risk_data.get("major_risk_patterns", [])
                    
                    if major_patterns:
                        majors = [m["major"] for m in major_patterns[:8]]
                        low = [m["risk_breakdown"]["low"] for m in major_patterns[:8]]
                        medium = [m["risk_breakdown"]["medium"] for m in major_patterns[:8]]
                        high = [m["risk_breakdown"]["high"] for m in major_patterns[:8]]
                        critical = [m["risk_breakdown"]["critical"] for m in major_patterns[:8]]
                        
                        fig_major_risk = go.Figure()
                        fig_major_risk.add_trace(go.Bar(name='Low', x=majors, y=low, marker_color='#10b981'))
                        fig_major_risk.add_trace(go.Bar(name='Medium', x=majors, y=medium, marker_color='#f59e0b'))
                        fig_major_risk.add_trace(go.Bar(name='High', x=majors, y=high, marker_color='#ef4444'))
                        fig_major_risk.add_trace(go.Bar(name='Critical', x=majors, y=critical, marker_color='#dc2626'))
                        
                        fig_major_risk.update_layout(
                            barmode='stack',
                            height=350,
                            paper_bgcolor='rgba(0,0,0,0)',
                            plot_bgcolor='rgba(0,0,0,0)',
                            font=dict(color='#e2e8f0', size=11),
                            xaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Major", tickangle=-45),
                            yaxis=dict(gridcolor='rgba(94,234,212,0.1)', title="Number of Students"),
                            legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
                            margin=dict(l=20, r=20, t=60, b=80)
                        )
                        
                        st.plotly_chart(fig_major_risk, use_container_width=True)
                
                # At-Risk Students Table
                st.markdown("### üö® At-Risk Students Requiring Immediate Attention")
                
                at_risk_students = risk_data.get("at_risk_students", [])
                
                if at_risk_students:
                    for student in at_risk_students[:15]:
                        risk_level = student.get("risk_level", "low")
                        risk_colors_emoji = {
                            "critical": ("üî¥", "#dc2626"),
                            "high": ("üü†", "#ef4444"),
                            "medium": ("üü°", "#f59e0b"),
                            "low": ("üü¢", "#10b981")
                        }
                        emoji, color = risk_colors_emoji.get(risk_level, ("‚ö™", "#64748b"))
                        
                        with st.expander(
                            f"{emoji} {student.get('name', 'Unknown')} - {risk_level.upper()} Risk | "
                            f"GPA: {student.get('gpa', 'N/A')} | Escalations: {student.get('total_escalations', 0)}",
                            expanded=(risk_level == "critical")
                        ):
                            col_a, col_b, col_c = st.columns(3)
                            with col_a:
                                st.markdown(f"**Student ID:** {student.get('student_id', 'N/A')}")
                                st.markdown(f"**Major:** {student.get('major', 'Undeclared')}")
                            with col_b:
                                st.markdown(f"**GPA:** {student.get('gpa', 'N/A')}")
                                st.markdown(f"**Total Questions:** {student.get('total_questions', 0)}")
                            with col_c:
                                st.markdown(f"**Total Escalations:** {student.get('total_escalations', 0)}")
                                st.markdown(f"**Top Concern:** {student.get('top_concern', 'None')}")
                            
                            st.markdown(f"**Last Interaction:** {student.get('last_interaction', 'N/A')}")
                            
                            if student.get("risk_level") in ["high", "critical"]:
                                st.warning(f"‚ö†Ô∏è **Action Required**: Immediate advisor outreach recommended")
                else:
                    st.success("‚úÖ No students currently at high risk!")
                
        except Exception as e:
            st.error(f"Error loading risk identification data: {e}")
        
        st.markdown("---")
        
        # === DATA MANAGEMENT ===
        st.markdown('<p class="section-header">üîß Data Management</p>', unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("üîÑ Regenerate Analytics Data", type="secondary", use_container_width=True):
                with st.spinner("Regenerating analytics data..."):
                    try:
                        regen_resp = requests.post(f"{API_BASE}/admin/analytics/regenerate-data", timeout=30)
                        if regen_resp.status_code == 200:
                            st.success("‚úÖ Analytics data regenerated successfully!")
                            time.sleep(1)
                            st.rerun()
                        else:
                            st.error("Failed to regenerate data")
                    except Exception as e:
                        st.error(f"Error: {e}")
        
        with col2:
            st.download_button(
                label="üì• Export Analytics Report",
                data="Analytics report export feature coming soon...",
                file_name=f"analytics_report_{datetime.now().strftime('%Y%m%d')}.txt",
                mime="text/plain",
                use_container_width=True
            )
        
        with col3:
            if st.button("üìä Refresh Dashboard", type="primary", use_container_width=True):
                st.rerun()

# === Footer ===
st.markdown("""<div class="footer">
    <p><span class="footer-highlight">SUNY Academic Assistant</span> | RAG + Study Tools</p>
    <p>Always double-check with your advisor for official info</p>
</div>""", unsafe_allow_html=True)